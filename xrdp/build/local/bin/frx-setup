#!/bin/bash

# Copyright (c) 2019 FEROX YT EIRL, www.ferox.yt <devops@ferox.yt>
# Copyright (c) 2019 Jérémy WALTHER <jeremy.walther@golflima.net>
# See <https://github.com/frxyt/docker-xrdp> for details.

# Display version
cat /frx/version
echo

# Execute requested command if needed
if [ -n "${FRX_CMD_INIT}" ]; then
    echo "Executing command : '${FRX_CMD_INIT}' ..."
    source <(echo "${FRX_CMD_INIT}")
    unset FRX_CMD_INIT
fi

# Run apt-get upgrade & install asked packages if needed
[[ "${FRX_APTGET_DISTUPGRADE}" == '1' || -n "${FRX_APTGET_INSTALL}" ]] && DEBIAN_FRONTEND=noninteractive apt-get update -y
[[ "${FRX_APTGET_DISTUPGRADE}" == '1' ]] && DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade -y
[[ -n "${FRX_APTGET_INSTALL}" ]] && DEBIAN_FRONTEND=noninteractive apt-get install -y --fix-missing --no-install-recommends ${FRX_APTGET_INSTALL}
unset FRX_APTGET_UPGRADE FRX_APTGET_INSTALL

# Create user if it doesn't exist
if ! id -u ${FRX_XRDP_USER_NAME} > /dev/null 2>&1; then
    # Copy default desktop icons if needed
    [[ "${FRX_XRDP_USER_COPY_SA}" == '1' ]] \
        && mkdir -p /etc/skel/Desktop \
        && cp /usr/share/applications/*.desktop /etc/skel/Desktop \
    echo -n "Creating user '${FRX_XRDP_USER_NAME}' ... "
    # Create user
    /usr/sbin/groupadd -g ${FRX_XRDP_USER_GID} ${FRX_XRDP_USER_NAME}
    [[ -d "/home/${FRX_XRDP_USER_NAME}" ]] \
        && /usr/sbin/useradd -g ${FRX_XRDP_USER_GID} -s /bin/bash -u ${FRX_XRDP_USER_UID} ${FRX_XRDP_USER_NAME} \
        || /usr/sbin/useradd -g ${FRX_XRDP_USER_GID} -ms /bin/bash -u ${FRX_XRDP_USER_UID} ${FRX_XRDP_USER_NAME}
    # Add user to adm group
    /usr/sbin/adduser ${FRX_XRDP_USER_NAME} adm > /dev/null
    # Set password
    echo ${FRX_XRDP_USER_NAME}:${FRX_XRDP_USER_PASSWORD} | /usr/sbin/chpasswd
    # Add user to sudo if needed
    [[ "${FRX_XRDP_USER_SUDO}" == '1' ]] && /usr/sbin/adduser ${FRX_XRDP_USER_NAME} sudo > /dev/null
    echo "[OK]"
fi

# Enable passwordless sudo group
sed -i "s/^%sudo.*/%sudo   ALL=(ALL:ALL) NOPASSWD: ALL/g" /etc/sudoers

# Clear user ENV variables
unset FRX_XRDP_USER_NAME FRX_XRDP_USER_PASSWORD FRX_XRDP_USER_SUDO FRX_XRDP_USER_GID FRX_XRDP_USER_UID FRX_XRDP_USER_COPY_SA

# Adjust TimeZone
echo "Setting time zone to: '${TZ}' ..."
ln -snf "/usr/share/zoneinfo/${TZ}" /etc/localtime
echo "${TZ}" > /etc/timezone
dpkg-reconfigure -f noninteractive tzdata

